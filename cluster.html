<!--

@license CC BY-NC 4.0 US
Copyright DigitalArsenal.IO, Inc., Lyteworx LLC.
ALL RIGHTS RESERVED.
 
-->

<script type="text/x-red" data-template-name="cluster">
  <div class="form-row" id="cluster-input-mode">
    <label for="node-config-input-strategy" style="width:50%""><i class="fa fa-th-list"></i> Distribution Strategy</label>
    <select id="strategies">
    </select>
    <br />
  </div>
  <div class="form-row">
      <input type="checkbox" id="node-input-payloadOnly" placeholder="" style="display: inline-block; width: auto; vertical-align: top;">
      <label for="node-input-payloadOnly" style="width: 70%;"><span>Transmit Payload Only</span></label>
  </div>
  <div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="common.label.name"></span></label>
    <div style="display: inline-block; width: calc(100% - 105px)"><input type="text" id="node-input-name" data-i18n="[placeholder]common.label.name"></div>
</div>
</script>
<style>
</style>
<script type="text/x-red" data-help-name="cluster">
  <p>Cluster Node For Distributed Computing</p>
   This node module takes an input from one to many processes and distributes it across one to many processes.</br>
   <h3>Configuration</h3>
   <dl class="message-properties">
    <dt>Distribution Strategy
      <span class="property-type">enumeration</span>
    </dt>
    <ul>
      <li><code>enableOnly</code>, if selected, ...</li>
      <li><code>randomWorker</code>, if selected, ...</li>
      <li><code>sendToBingo</code>, if selected, ...</li>
      <li><code>runOnBingo</code>, If selected, ...</li>
      <li><code>broadcast</code>, If selected, ...</li>
      <li><code>roundRobin</code>, If selected, ...</li>
  </ul>
  
    <dt>Transmit Payload Only
      <span class="property-type">boolean</span>
    </dt>
    <dd>enable only</dd>
  </dl>
   <h3>Outputs</h3>
   <p>None</p>
   <h3>Details</h3>

   <p>The flows run on the configured number of processors, one process per processor.</p>
   <p>To use parallel processing of tasks (more than one processor per flow),</p>
   <p>this cluster node is available to configure interprocess communication (IPC).</p>
</script>

<script type="text/javascript">
  /*  
   * List of strategies
   * - master:randomWorker
   * - master:getSpecificWorker
   * - master:roundRobin
   * - master:broadcast
   */
  (() => {

    let strategies = {
      'Enable Clustering': 'enableOnly',
      'Send to Random Worker': 'randomWorker',
      'Run On Bingo Process': 'runOnBingo',
      'Send To Bingo Process': 'sendToBingo',
      'Broadcast': 'broadcast',
      'RoundRobin': 'roundRobin'
    };

    RED.nodes.registerType('cluster', {
      category: 'unionstation',
      color: "#E9967A",
      defaults: {
        mode: {
          value: "randomWorker"
        },
        /*bingoOnly: {
          value: true
        },*/
        payloadOnly: {
          value: true
        }
      },
      icon: "cluster.png",
      inputs: 1,
      outputs: 1,
      name: null,
      outputLabels: function (index) { },
      label: function () {

        let label = Object.entries(strategies).filter(a => a[1] === this.mode)[0][0];

        return this.name || `cluster: ${label}`;
      },
      labelStyle: function () {
        return this.name ? "node_label_italic" : "";
      },
      oneditprepare: function () {
        let node = this;
        node.strategies = strategies;
        let setStrategies = (strategies) => {
          if (strategies) {
            node.strategies = strategies;
          }
          Object.entries(node.strategies).forEach(s => {
            $('#strategies').append(`
          <option ${this.mode === s[1] ? 'selected="selected"' : ''} value="${s[1]}">${s[0]}</option>
          `);
          })
        };
        if (!this.strategies) {
          $.get(window.location.pathname + '6660d4cd-cc89-4f2a-a20b-1ff66353d26b').then(function (strategies) {
            setStrategies(strategies);
          });
        } else {
          setStrategies();
        }
        $("#strategies").val(this.mode);
        $("#strategies").change(function () {
          if (this.value === 'enableOnly') {
            node.inputs = 0;
            node.outputs = 0;
          } else {
            node.inputs = 1;
            node.outputs = 1;
          }
        })
      },
      oneditsave: function () {
        this.mode = $("#strategies").val();
      }
    });
  })()
</script>